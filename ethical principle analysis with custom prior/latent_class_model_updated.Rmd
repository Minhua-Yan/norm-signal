---
title: "Latent Class Model: One Ethical Principle per Subject"
output: 
   html_document:
     self_contained: false
---

```{r setup, include=FALSE}
# Load required libraries
knitr::opts_chunk$set(echo = TRUE)
library(cmdstanr)
library(posterior)
library(tidyverse)
library(readxl)
library(bayesplot)
library(gtools)
```

## Load Emission Probabilities and Prepare Data

```{r data-prep}
emission_raw <- read_csv("emission_probs_softened_moderate.csv")
principles <- colnames(emission_raw)[-1]
C <- 3
K <- length(principles)
J <- nrow(emission_raw)

emission_probs <- array(0, dim = c(C, K, J))
for (j in 1:J) {
  for (k in 1:K) {
    emission_probs[, k, j] <- as.numeric(str_split(emission_raw[[k+1]][j], ",")[[1]])
  }
}

df <- read_csv("ethics_deidentified.csv")

df <- df %>%
  mutate(
    response = str_trim(response),
    response = recode(response,
                      "SBJ" = 1,
                      "HD"  = 2,
                      "CFP" = 3)
  )

df <- df %>% mutate(person_id = as.integer(factor(id)))
context_labels <- emission_raw$Context
df <- df %>% mutate(context_id = as.integer(factor(context, levels = context_labels)))

I <- length(unique(df$person_id))

alpha_vector <- c(
  selfish = 0.2,
  generous = 0.2,
  tradition = 0.2,
  rewardLBonly = 0.2 / 7,
  rewardLDonly = 0.2 / 7,
  rewardRSonly = 0.2 / 7,
  rewardLB_LD = 0.2 / 7,
  rewardLB_RS = 0.2 / 7,
  rewardLD_RS = 0.2 / 7,
  rewardALL = 0.2 / 7,
  random = 0.2
)

data_list <- list(
  N = nrow(df),
  I = I,
  K = K,
  C = C,
  J = J,
  y = df$response,
  context = df$context_id,
  person = df$person_id,
  emission_probs = emission_probs,
  alpha = alpha_vector
)
```

## Compile and Fit the Marginalized Model

```{r stan-model}
mod <- cmdstan_model("single_z_per_subject_model_explicit.stan")
fit <- mod$sample(data = data_list, seed = 123, chains = 4, parallel_chains = 4, adapt_delta = 0.99)
fit$summary("pi")
```

## Plot the Estimated Posterior Distribution

```{r posterior-plot}
posterior_pi <- as.data.frame(fit$draws("pi", format = "draws_matrix"))
colnames(posterior_pi) <- principles
posterior_pi <- posterior_pi %>%
  mutate(`reward contribution(s)` = rewardLBonly + rewardLDonly + rewardRSonly + rewardLB_LD + rewardLB_RS + rewardLD_RS + rewardALL) %>%
  select(selfish, generous, tradition, `reward contribution(s)`, random)

means <- colMeans(posterior_pi)
ci_lower <- apply(posterior_pi, 2, quantile, probs = 0.025)
ci_upper <- apply(posterior_pi, 2, quantile, probs = 0.975)

desired_order <- c("generosity", "tradition\n compliance", "reward\n contribution(s)", "selfishness","random")


summary_post <- data.frame(
  ethical_principle = names(means),
  mean = means,
  ci_lower = ci_lower,
  ci_upper = ci_upper
)

summary_post <- summary_post %>%
  mutate(ethical_principle = recode(ethical_principle,
         "tradition" = "tradition\n compliance",
         "reward contribution(s)" = "reward\n contribution(s)",
         "generous" = "generosity",
         "selfish" = "selfishness")
         ) %>%
  mutate(ethical_principle = factor(ethical_principle, levels = desired_order))

ggplot(summary_post, aes(x = ethical_principle, y = mean)) +
  geom_point(color = "steelblue", size = 3) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2, color = "gray50") +
  labs(title = "Estimated Prevalence of Ethical Principles", y = "Proportion of respondents holding an ethical principle", x = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 20, hjust = 1, size=14), plot.title = element_text(hjust = 0.5))
```

## Plot the Prior Distribution for 5 ethical principles

```{r prior-plot}
prior_draws <- rdirichlet(5000, alpha_vector)
colnames(prior_draws) <- names(alpha_vector)
prior_df <- as.data.frame(prior_draws)

prior_df <- prior_df %>%
  mutate(`reward contribution(s)` = rewardLBonly + rewardLDonly + rewardRSonly + rewardLB_LD + rewardLB_RS + rewardLD_RS + rewardALL) %>%
  select(selfish, generous, tradition, `reward contribution(s)`, random)

prior_means <- colMeans(prior_df)
prior_ci_lower <- apply(prior_df, 2, quantile, probs = 0.025)
prior_ci_upper <- apply(prior_df, 2, quantile, probs = 0.975)

summary_prior <- data.frame(
  ethical_principle = names(prior_means),
  mean = prior_means,
  ci_lower = prior_ci_lower,
  ci_upper = prior_ci_upper
)

desired_order <- c("generosity", "tradition\n compliance", "reward\n contribution(s)", "selfishness","random")

summary_prior <- summary_prior %>%
 mutate(ethical_principle = recode(ethical_principle,
         "tradition" = "tradition\n compliance",
         "reward contribution(s)" = "reward\n contribution(s)",
         "generous" = "generosity",
         "selfish" = "selfishness")
         ) %>%
  mutate(ethical_principle = factor(ethical_principle, levels = desired_order))

ggplot(summary_prior, aes(x = ethical_principle, y = mean)) +
  geom_point(color = "darkgreen", size = 3) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2, color = "gray50") +
  labs(title = "Prior Distribution over Ethical Principles", y = "Prior probability", x = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 20, hjust = 1), plot.title = element_text(hjust = 0.5))
```

## Plot the Prior Distribution for base-level ethical principles

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 7}
prior_draws <- rdirichlet(5000, alpha_vector)
colnames(prior_draws) <- names(alpha_vector)
prior_df <- as.data.frame(prior_draws)


prior_means <- colMeans(prior_df)
prior_ci_lower <- apply(prior_df, 2, quantile, probs = 0.025)
prior_ci_upper <- apply(prior_df, 2, quantile, probs = 0.975)

desired_order <- c("generosity", "tradition\n compliance", "reward\n labor", "reward\n land", "reward\n resource", "reward labor\n and land", "reward labor\n and resource", "reward land\n and resource", "reward\n all three", "selfishness","random")


summary_prior <- data.frame(
  ethical_principle = names(prior_means),
  mean = prior_means,
  ci_lower = prior_ci_lower,
  ci_upper = prior_ci_upper
)

summary_prior <- summary_prior %>%
  mutate(ethical_principle = recode(ethical_principle,
         "tradition" = "tradition\n compliance",
         "rewardALL" = "reward\n all three",
         "rewardLBonly" = "reward\n labor",
         "rewardLDonly" = "reward\n land",
         "rewardRSonly" = "reward\n resource",
         "rewardLB_LD" = "reward labor\n and land",
         "rewardLB_RS" = "reward labor\n and resource",
         "rewardLD_RS" = "reward land\n and resource",
         "generous" = "generosity",
         "selfish" = "selfishness")
         ) %>%
  mutate(ethical_principle = factor(ethical_principle, levels = desired_order))



ggplot(summary_prior, aes(x = ethical_principle, y = mean)) +
  geom_point(color = "darkgreen", size = 3) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2, color = "gray50") +
  labs(title = "Prior Distribution over Ethical Principles", y = "Prior probability", x = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 20, hjust = 1), plot.title = element_text(hjust = 0.5))
```
